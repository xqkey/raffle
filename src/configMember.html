<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>奖项设置</title>
    <link rel="stylesheet" href="css/reset.css" />
    <!-- <link rel="stylesheet" href="https://cdn.bootcss.com/element-ui/2.4.1/theme-chalk/index.css" /> -->
    <link rel="stylesheet" href="./js/element-ui@2.4.11/lib/theme-chalk/index.css">
    <script src="js/polyfill.min.js"></script>
    <script src="js/vue.min.js"></script>
    <!-- <script src="https://cdn.bootcss.com/element-ui/2.4.1/index.js"></script> -->
    <script src="./js/element-ui@2.4.11/lib/index.js"></script>
    <script src="js/member.js"></script>
    <style>
        .el-input {
            width: 120px;
        }

        .el-table {
            margin-bottom: 10px;
        }

        * {
            cursor: initial;
        }

        .awards,
        .members {
            width: 80%;
            margin: auto;
            margin-top: 50px;
        }

        h1 {
            font-size: 30px;
            text-align: center;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        h1 span {
            font-size: 16px;
        }

        a {
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="members">
            <el-steps :active="1">
                <el-step title="参与人员设置"></el-step>
                <el-step title="奖项设置"></el-step>
                <el-step title="抽奖方式设置"></el-step>
            </el-steps>
            <br/>
            <h1>参与人员列表(共{{memberSource.length}}人)</h1>
            <el-table :data="memberSourceTable" style="width: 100%" stripe>
                <el-table-column :prop="item.prop" :label="item.label" width="180" v-for="(item, index) in memberColumns" :key="index">
                    <template slot-scope="scope">
                        <div>
                            <div v-if="scope.row.editing[item.prop]">
                                <el-input size="mini" v-model="scope.row[item.prop]" @blur="onSaveCell(scope.row, item.prop)"></el-input>
                            </div>
                            <div v-else @dblclick="onEditCell(scope.row, item.prop, $event)">
                                {{ scope.row[item.prop] || '(请填写)' }}
                            </div>
                        </div>
                    </template>
                </el-table-column>
                <el-table-column prop="address" label="操作">
                    <template slot-scope="scope">
                        <el-button size="small" @click="onRemoveMember(scope.row, scope.$index)" type="danger">
                            删除
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>
            <el-pagination
                layout="prev, pager, next"
                :total="memberSource.length"
                :page-size="pagination.pageSize"
                :current-page="pagination.currentPage"
                @current-change="onChangePage">
            </el-pagination>
            <el-button size="small" type="primary" @click="onAddMember">增加一位</el-button>
            <el-button size="small" type="primary" @click="onBatchAddMember">批量增加</el-button>
            <el-button size="small" type="warning" @click="onImport">重置</el-button>
            <el-button size="small" type="primary" @click="onNextPage">下一步</el-button>
        </div>
    </div>
    <script>
        new Vue({
            el: '#app',
            data: {
                memberColumns: [
                    {
                        prop: 'id',
                        label: '工号',
                    },
                    {
                        prop: 'name',
                        label: '姓名',
                    },
                ],
                memberSourceTable: [],
                memberSource: [],
                pagination: {
                    pageSize:10,
                    currentPage:1,
                    currentNum:0,
                },
            },
            computed: {
                members: function () {
                    return this.memberSource
                        .filter(function (item) {
                            return item.name && item.id;
                        })
                        .map(function (item) {
                            return {
                                name: item.name,
                                id: item.id,
                            };
                        });
                },
            },
            methods: {
                onSaveCell: function (row, key) {
                    this.$set(row.editing, key, false);
                    this.saveData();
                },
                onEditCell: function (row, key, e) {
                    this.$set(row.editing, key, true);
                    const parent = e.target.parentNode;
                    this.$nextTick(function () {
                        // console.log(parent.innerHTML, row)
                        parent.querySelector('input').focus();
                    });
                },
                onAddMember: function () {
                    this.memberSource.push({
                        editing: {
                            name: true,
                        },
                    });
                    let baseNum1 = (this.pagination.currentPage - 1) * this.pagination.pageSize;
                    let baseNum2 = baseNum1 + this.pagination.pageSize;
                    if (baseNum2 <= this.memberSource.length) {
                        this.pagination.currentNum = this.pagination.pageSize;
                    }
                    else
                    {
                        this.pagination.currentNum = this.memberSource.length - baseNum1;
                    }
                    this.updateTable();
                },
                onBatchAddMember: function () {
                    this.$prompt('请输需要增加的人数', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        inputPattern: /^[1-9]\d*$/,
                        inputErrorMessage: '只能输入大于0的数字'
                    }).then(({ value }) => {
                        this.$message({
                            type: 'success',
                            message: '你添加的人数是: ' + value
                        });

                        let maxid = this.memberSource.reduce( (a, c, i) => c > a ? (indexOfMax = i, c.id) : a, 0);
                        for (let i = 0; i < value; i++) {
                            maxid += 1
                            this.memberSource.push({
                                name: maxid + '号',
                                id: maxid,
                                editing: {},
                            });
                        }

                        let baseNum1 = (this.pagination.currentPage - 1) * this.pagination.pageSize;
                        let baseNum2 = baseNum1 + this.pagination.pageSize;
                        if (baseNum2 <= this.memberSource.length) {
                            this.pagination.currentNum = this.pagination.pageSize;
                        }
                        else {
                            this.pagination.currentNum = this.memberSource.length - baseNum1;
                        }
                        this.updateTable();
                        this.saveData();
                    }).catch(() => {
                        this.$message({
                            type: 'info',
                            message: '取消输入'
                        });
                    });
                },
                onRemoveMember: function (row, index) {
                    var vm = this;
                    this.$confirm('删除不可撤销！可重新添加', '确定删除吗？', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning',
                    }).then(function () {
                        vm.memberSource.splice(index, 1);
                        vm.saveData();
                    });
                },
                onImport: function () {
                    var vm = this;
                    this.$confirm('重新导入会覆盖现有人员列表', '确定重置吗？', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning',
                    }).then(function () {
                        vm.memberSource = window.members.map(function (item) {
                            return {
                                name: item.name,
                                id: item.id,
                                editing: {},
                            };
                        });

                        // 计算当前页的数量
                        vm.pagination.currentNum = vm.memberSource.length % vm.pagination.pageSize;
                        if (vm.pagination.currentNum === 0 && vm.memberSource.length > 0) {
                            vm.pagination.currentNum = vm.pagination.pageSize;
                        }
                        console.log('Init current num:' + vm.pagination.currentNum);

                        // 计算当前页码
                        vm.pagination.currentPage = (vm.memberSource.length - vm.pagination.currentNum) / vm.pagination.pageSize + 1;
                        console.log('Init current page:' + vm.pagination.currentPage);

                        vm.updateTable();
                        vm.saveData();
                    });
                },
                onNextPage: function () {
                    localStorage.setItem('stepNum', '2');
                    location.href = 'configAward.html';
                },
                saveData: function () {
                    localStorage.setItem('members', JSON.stringify(this.members));
                    localStorage.setItem('players', JSON.stringify(this.members));//奖池人员
                },
                updateTable: function () {
                    this.memberSourceTable = [];
                    let baseNum = (this.pagination.currentPage - 1) * this.pagination.pageSize;
                    for (let i = 0; i < this.pagination.currentNum ; i++) {
                        this.memberSourceTable.push(this.memberSource[baseNum + i]);
                    }
                },
                onChangePage: function (page) {
                    this.pagination.currentPage = page;
                    let baseNum1 = (this.pagination.currentPage - 1) * this.pagination.pageSize;
                    let baseNum2 = baseNum1 + this.pagination.pageSize;
                    if (baseNum2 <= this.memberSource.length) {
                        this.pagination.currentNum = this.pagination.pageSize;
                    }
                    else
                    {
                        this.pagination.currentNum = this.memberSource.length - baseNum1;
                    }
                    
                    //console.log('current num:'+this.pagination.currentNum);
                    //console.log('current page:'+this.pagination.currentPage);
                    this.updateTable();
                },
            },
            created: function () {
                localStorage.setItem('stepNum', '1');

                var members = JSON.parse(localStorage.getItem('members')) || window.members;
                this.memberSource = members.map(function (item) {
                    return {
                        name: item.name,
                        id: item.id,
                        editing: {},
                    };
                });

                // 计算当前页的数量
                this.pagination.currentNum = this.memberSource.length % this.pagination.pageSize;
                if (this.pagination.currentNum === 0 && this.memberSource.length > 0) {
                    this.pagination.currentNum = this.pagination.pageSize;
                }
                console.log('Init current num:' + this.pagination.currentNum);

                // 计算当前页码
                this.pagination.currentPage = (this.memberSource.length - this.pagination.currentNum) / this.pagination.pageSize + 1;
                console.log('Init current page:' + this.pagination.currentPage);

                this.updateTable();
                this.saveData();
            },
        });
    </script>
</body>

</html>